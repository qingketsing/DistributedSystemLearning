# Lec5 & Raft

## 论文部分: Raft

### Raft介绍

Raft是用来管理复制日志的共识算法。它的效果和效率与Paxos一样，但是结构不同；这使得Raft比Paxos更容易理解，同时为构建实际系统提供良好的基础。

特点: 

1. 更有权力的Leader: 日志条目只会从leader流向其他的server。
2. Leader选举: 在心跳连接的基础上加入了少量机制，来实现快速的解决问题。
3. 集群成员变化: 允许集群在配置变化时也可以正常执行。

### 复制状态机

对于复制状态机的集群而言，要想服务器集群中的状态机计算某一状态的相同副本，即使某些服务器宕机也可以继续运行，就需要共识算法。

复制状态机被用来解决一系列分布式系统的FT(Fault tolerance)问题。比较经典的案例就是vm-ft，在前面的文章中有讲过。

共识算法的任务就是保证复制日志的一致性。

用于实际应用的共识算法需要有以下特征:

1. 安全性: 不会返回错误的结果，非拜占庭条件，包括网络延迟、分片和丢包、重复。
2. 可靠性: 即使有部分服务器宕机，也可以正常运行，并且让服务器重启后可以重新加入集群。
3. 不依赖时间来保证日志一致性: 不会产生由于错误的时钟导致的可靠性问题。
4. 少数慢服务器不影响整体系统性能

### Paxos的问题:

主要就是两个问题，难理解，难实现。

Paxos的核心——单法令Paxos本身就“密集而微妙”。它被分成两个没有简单直观解释的阶段，且这两个阶段无法独立理解。

缺乏标准实现：对于如何构建多Paxos，Lamport的描述大多停留在单法令阶段，仅勾勒了可能的思路，缺乏关键细节。架构不实用，独立选择一系列日志条目，再将它们合并成一个有序日志，这增加了复杂性。领导者的作用较弱，实际操作难度更大。

### Raft共识算法:

对于Raft共识算法，它把复杂的问题分解为:Leader选举，日志复制，安全性保障三个子问题。

#### Leader选举:

首先，服务器有三种状态，Leader, Follower, Candidate 

如果 Follower 在 选举超时时间 内没有收到 Leader 的心跳，它就变成 Candidate，开始选举。follower增加它的当前任期号，然后转换为candidate状态。它为自己投票，而且给集群中所有的服务器并行发出RequestVote RPC。一个candidate继续保持它的状态直到有以下一种情况发生：
1. 它赢得了选举
2. 另一个服务器成为了leader
3. 没有leader产生

对于选举结果有以下几种情况:
1. 获得多数派投票 → 成为 Leader。
2. 发现已有 Leader：收到来自更高或相等 Term 的 AppendEntries → 退回 Follower。
3. 选举超时：无人胜出 → 增加 Term，重新开始选举。

### 日志复制:

